name: Draft release

on:
  pull_request:
    branches:
      - next

jobs:
  build_dist:
    name: Build dist files
    if: startsWith(github.head_ref , 'release/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: '16'
      - run: npm ci
  version_tag_release_draft:
    name: Version and tag release draft
    if: startsWith(github.head_ref , 'release/')
    runs-on: ubuntu-latest
    # https://docs.github.com/en/actions/using-jobs/defining-outputs-for-jobs
    outputs:
      new_tag: ${{ steps.bump_version.outputs }}
    steps:
      - name: Parse changelog
        id: get_changelog
        run: echo "changelog=$(npm run changelog)" >> "$GITHUB_OUTPUT"
      # https://stackoverflow.com/questions/59191913/how-do-i-get-the-output-of-a-specific-step-in-github-actions
      - name: Determine version bump
        id: determine_bump
        run: |
          echo "isMajor=${{ contains(steps.get_changelog.outputs.changelog, '!:') }}" >> "$GITHUB_OUTPUT"
          echo "isMinor=$(${{ contains(steps.get_changelog.outputs.changelog, 'feat') }} && NOT $isMajor)" >> "$GITHUB_OUTPUT"
      - name: Increment version
        id: bump_version
        run: |
          npm version ${{ (steps.determine_bump.outputs.isMajor && 'major') || (steps.determine_bump.outputs.isMinor && 'minor') || 'patch' }} -m "chore(release): Bumps version to v%s and updates dist files"
  create_release_draft:
    name: Create release draft
    runs-on: ubuntu-latest
    needs: version_tag_release_draft
    steps:
      - name: Make notes
        id: make_notes
        uses: mikepenz/release-changelog-builder-action@v4.1.1
      - name: Make release draft
        id: release_draft
        run: echo "Creating release draft"
        # run: |
        #     gh release create ${{jobs.version_tag_release_draft.outputs.new_tag}} \
        #         --repo="$GITHUB_REPOSITORY" \
        #         --title="${GITHUB_REPOSITORY#*/} ${{jobs.version_tag_release_draft.outputs.new_tag}}" \
        #         --notes ${{steps.make_notes.outputs.changelog}} \
        #         --draft
